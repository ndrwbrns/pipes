var dissolveEndCallback,gridBounds=new THREE.Box3(new THREE.Vector3(-10,-10,-10),new THREE.Vector3(10,10,10)),nodes={};function setAt(e,t){nodes["("+e.x+", "+e.y+", "+e.z+")"]=t}function getAt(e,t){return nodes["("+e.x+", "+e.y+", "+e.z+")"]}function clearGrid(){nodes={}}var textures={},Pipe=function(e,t){var n=this;if(n.currentPosition=randomIntegerVector3WithinBox(gridBounds),n.positions=[n.currentPosition],n.object3d=new THREE.Object3D,e.add(n.object3d),t.texturePath)n.material=new THREE.MeshLambertMaterial({map:textures[t.texturePath]});else{var o=randomInteger(0,16777215),r=new THREE.Color(o).multiplyScalar(.3);n.material=new THREE.MeshPhongMaterial({specular:11140351,color:o,emissive:r,shininess:100})}var i=function(e,t,o){var r=new THREE.Vector3().subVectors(t,e),i=new THREE.ArrowHelper(r.clone().normalize(),e),a=new THREE.CylinderGeometry(.2,.2,r.length(),10,4,!0),s=new THREE.Mesh(a,o);s.rotation.setFromQuaternion(i.quaternion),s.position.addVectors(e,r.multiplyScalar(.5)),s.updateMatrix(),n.object3d.add(s)},a=function(e){var t=new THREE.Mesh(new THREE.SphereGeometry(.30000000000000004,8,8),n.material);t.position.copy(e),n.object3d.add(t)},s=function(e){var t=new THREE.Mesh(new THREE.TeapotBufferGeometry(.30000000000000004,!0,!0,!0,!0,!0),n.material);t.position.copy(e),t.rotation.x=Math.floor(random(0,50))*Math.PI/2,t.rotation.y=Math.floor(random(0,50))*Math.PI/2,t.rotation.z=Math.floor(random(0,50))*Math.PI/2,n.object3d.add(t)},c=function(e,t,o){var r=new THREE.Mesh(new THREE.SphereGeometry(.2,8,8),n.material);r.position.copy(e),n.object3d.add(r)};setAt(n.currentPosition,n),a(n.currentPosition),n.update=function(){if(n.positions.length>1)var e=n.positions[n.positions.length-2],o=new THREE.Vector3().subVectors(n.currentPosition,e);if(chance(.5)&&o)var r=o;else{var r=new THREE.Vector3;r[chooseFrom("xyz")]+=chooseFrom([1,-1])}var l=new THREE.Vector3().addVectors(n.currentPosition,r);!(!gridBounds.containsPoint(l)||getAt(l))&&(setAt(l,n),o&&!o.equals(r)&&(chance(t.teapotChance)?s(n.currentPosition):chance(t.ballJointChance)?a(n.currentPosition):c(n.currentPosition,l,o)),i(n.currentPosition,l,n.material),n.currentPosition=l,n.positions.push(l))}},JOINTS_ELBOW="elbow",JOINTS_BALL="ball",JOINTS_MIXED="mixed",JOINTS_CYCLE="cycle",jointsCycleArray=[JOINTS_ELBOW,JOINTS_BALL,JOINTS_MIXED],jointsCycleIndex=0,jointTypeSelect=document.getElementById("joint-types"),pipes=[],options={multiple:!0,texturePath:null,joints:jointTypeSelect.value,interval:[16,24]};jointTypeSelect.addEventListener("change",function(){options.joints=jointTypeSelect.value});var canvasContainer=document.getElementById("canvas-container"),canvas2d=document.getElementById("canvas-2d"),ctx2d=canvas2d.getContext("2d"),canvasWebGL=document.getElementById("canvas-webgl"),renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0,canvas:canvasWebGL});renderer.setSize(window.innerWidth,window.innerHeight);var camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,1e5),controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enabled=!1;var scene=new THREE.Scene,ambientLight=new THREE.AmbientLight(1118481);scene.add(ambientLight);var directionalLightL=new THREE.DirectionalLight(16777215,.9);directionalLightL.position.set(-1.2,1.5,.5),scene.add(directionalLightL);var dissolveRects=[],dissolveRectsIndex=-1,dissolveRectsPerRow=50,dissolveRectsPerColumn=50,dissolveTransitionSeconds=2,dissolveTransitionFrames=60*dissolveTransitionSeconds;function dissolve(e,t){shuffleArrayInPlace(dissolveRects=Array((dissolveRectsPerRow=Math.ceil(window.innerWidth/20))*(dissolveRectsPerColumn=Math.ceil(window.innerHeight/20))).fill(null).map(function(e,t){return{x:t%dissolveRectsPerRow,y:Math.floor(t/dissolveRectsPerRow)}})),dissolveRectsIndex=0,dissolveTransitionFrames=60*(dissolveTransitionSeconds=e),dissolveEndCallback=t}function finishDissolve(){dissolveEndCallback(),dissolveRects=[],dissolveRectsIndex=-1,ctx2d.clearRect(0,0,canvas2d.width,canvas2d.height)}var clearing=!1,clearTID=-1;function clear(e){clearTimeout(clearTID),clearTID=setTimeout(clear,1e3*random(options.interval[0],options.interval[1])),!clearing&&(clearing=!0,dissolve(e?.2:2,reset))}function reset(){renderer.clear();for(var e=0;e<pipes.length;e++)scene.remove(pipes[e].object3d);pipes=[],clearGrid(),look(),clearing=!1}function animate(){if(controls.update(),options.texturePath&&!textures[options.texturePath]){var e=THREE.ImageUtils.loadTexture(options.texturePath);e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(2,2),textures[options.texturePath]=e}for(var t=0;t<pipes.length;t++)pipes[t].update(scene);if(0===pipes.length){var n=options.joints;options.joints===JOINTS_CYCLE&&(n=jointsCycleArray[jointsCycleIndex++]);var o={teapotChance:.005,ballJointChance:n===JOINTS_BALL?1:n===JOINTS_MIXED?1/3:0,texturePath:options.texturePath};if(chance(.05)&&(o.teapotChance=.05,o.texturePath="images/textures/candycane.png",!textures[o.texturePath])){var e=THREE.ImageUtils.loadTexture(o.texturePath);e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(2,2),textures[o.texturePath]=e}for(var t=0;t<1+options.multiple*(1+chance(.1));t++)pipes.push(new Pipe(scene,o))}if(clearing||renderer.render(scene,camera),(canvas2d.width!==window.innerWidth||canvas2d.height!==window.innerHeight)&&(canvas2d.width=window.innerWidth,canvas2d.height=window.innerHeight,dissolveRectsIndex>-1))for(var t=0;t<dissolveRectsIndex;t++){var r=dissolveRects[t],i=innerWidth/dissolveRectsPerRow,a=innerHeight/dissolveRectsPerColumn;ctx2d.fillStyle="black",ctx2d.fillRect(Math.floor(r.x*i),Math.floor(r.y*a),Math.ceil(i),Math.ceil(a))}if(dissolveRectsIndex>-1){for(var s=Math.floor(dissolveRects.length/dissolveTransitionFrames),t=0;t<s&&dissolveRectsIndex<dissolveRects.length;t++){var r=dissolveRects[dissolveRectsIndex],i=innerWidth/dissolveRectsPerRow,a=innerHeight/dissolveRectsPerColumn;ctx2d.fillStyle="black",ctx2d.fillRect(Math.floor(r.x*i),Math.floor(r.y*a),Math.ceil(i),Math.ceil(a)),dissolveRectsIndex+=1}dissolveRectsIndex===dissolveRects.length&&finishDissolve()}requestAnimationFrame(animate)}function look(){var e=new THREE.Vector3(14,0,0),t=new THREE.Vector3(random(-1,1.5,1),random(-1,1.5,1),random(-1,1.5,1)),n=new THREE.Matrix4().makeRotationAxis(t,Math.PI/2);e.applyMatrix4(n),camera.position.copy(e)}clearTID=setTimeout(clear,1e3*random(options.interval[0],options.interval[1]));var center=new THREE.Vector3(0,0,0);function updateFromParametersInURL(){var e=decodeURIComponent(location.hash.replace(/^#/,""));if(e)try{var t=JSON.parse(e);"object"!=typeof t&&(alert("Invalid URL parameter JSON: top level value must be an object"),t=null)}catch(n){alert("Invalid URL parameter JSON syntax\n\n"+n+"\n\nRecieved:\n"+e)}showElementsIf(".ui-container",!(t=t||{}).hideUI)}function random(e,t){return Math.random()*(t-e)+e}function randomInteger(e,t){return Math.round(random(e,t))}function chance(e){return Math.random()<e}function chooseFrom(e){return e[Math.floor(Math.random()*e.length)]}function shuffleArrayInPlace(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),o=e[t];e[t]=e[n],e[n]=o}}function randomIntegerVector3WithinBox(e){return new THREE.Vector3(randomInteger(e.min.x,e.max.x),randomInteger(e.min.y,e.max.y),randomInteger(e.min.z,e.max.z))}function showElementsIf(e,t){Array.from(document.querySelectorAll(e)).forEach(function(e){t?e.removeAttribute("hidden"):e.setAttribute("hidden","hidden")})}camera.lookAt(center),controls.update(),look(),addEventListener("resize",function(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()},!1),canvasContainer.addEventListener("mousedown",function(e){e.preventDefault(),controls.enabled||(e.button?clear(!0):look()),window.getSelection().removeAllRanges(),document.activeElement.blur()}),canvasContainer.addEventListener("contextmenu",function(e){e.preventDefault()},!1),updateFromParametersInURL(),window.addEventListener("hashchange",updateFromParametersInURL),animate();
